<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªéˆä¹‹å¢ƒï¼šå¤å¤é•·è€èˆ‡éƒ¨è½ä¹‹è²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Application Structure Plan: 
        Structure: Single-page application with a main content area dynamically updated. Header displays game/chapter title. Content area shows scene descriptions, narrator text, character dialogue. Interactive choices are presented as buttons.
        User Flow: Linear progression driven by a "Next" button (for narration/dialogue without immediate choices) or by making choices. Choices can lead to different narrative paths or unlock content. Game state is managed in JavaScript to track progress and effects of choices.
        Reasoning: This structure is common for visual novels, providing a clear and focused reading experience. Dynamic content updates keep the user engaged in the narrative. Storing the story as a graph of nodes allows for easy branching and state management.
    -->
    <!-- Visualization & Content Choices: 
        Report Info (Narrative Script) -> Goal (Interactive Storytelling)
        - Scene Descriptions/Narration: Text block -> Inform/Set Scene -> Displayed in a dedicated area -> JS updates content -> Clear narrative flow. (HTML/CSS/JS)
        - Dialogue: Character Name + Text -> Convey Character/Plot -> Styled text blocks -> JS updates content -> Differentiates speakers. (HTML/CSS/JS)
        - Choices (é¸é …): List of options -> Player Agency/Branching -> Clickable buttons -> JS handles choice logic, updates state, loads next node -> Core interactive mechanic. (HTML/CSS/JS)
        - Branching Outcomes (e.g., è§£é–èªéˆäº•æ­·å²ç‰‡æ®µ): Text/State Change -> Show Consequence/Reward -> Update narrative/game state -> JS manages state and displays relevant content -> Provides depth. (JS state management)
        - Visual Elements (e.g., "å…‰èŠ’å¾äº•ä¸­å°„å‡º"): Descriptive text -> Enhance Immersion -> Displayed as narrative text -> JS. (No actual graphics, relying on text.)
        - LLM Integration (Chapter 5): User input for rewrite suggestions -> LLM generates creative prompts/suggestions -> Displayed in a dedicated section -> Uses Gemini API for dynamic content generation -> Enhances creative interaction.
        - Background Images: Dynamic background images for different scenes to enhance visual storytelling. Implemented using CSS classes dynamically added/removed by JavaScript.
        CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-size: cover; /* åœ–ç‰‡è¦†è“‹æ•´å€‹èƒŒæ™¯ */
            background-position: center; /* åœ–ç‰‡ç½®ä¸­ */
            background-repeat: no-repeat; /* åœ–ç‰‡ä¸é‡è¤‡ */
            transition: background-image 1s ease-in-out; /* èƒŒæ™¯åœ–ç‰‡åˆ‡æ›æ™‚çš„æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
            background-attachment: fixed; /* èƒŒæ™¯åœ–ç‰‡å›ºå®šï¼Œä¸éš¨æ»¾å‹•æ¢æ»¾å‹• */
        }
        .dialogue-text-paragraph {
            white-space: pre-wrap;
        }
        #content-area::-webkit-scrollbar {
            width: 8px;
        }
        #content-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #content-area::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #content-area::-webkit-scrollbar-thumb:hover {
            background: #555;
            cursor: pointer; /* Add pointer cursor on hover */
        }

        /* èƒŒæ™¯åœ–ç‰‡æ¨£å¼å®šç¾© */
        .bg-well {
            background-image: url('https://placehold.co/1920x1080/2C3E50/E0F2F7?text=èªéˆä¹‹äº•'); /* èªéˆä¹‹äº• */
        }
        .bg-highlands {
            background-image: url('https://placehold.co/1920x1080/34495E/A2D9CE?text=æ˜Ÿæ¨¹é«˜åŸ'); /* æ˜Ÿæ¨¹é«˜åŸ */
        }
        .bg-floating-island {
            background-image: url('https://placehold.co/1920x1080/1ABC9C/D5F5E3?text=æ°´é¤ƒæµ®å³¶'); /* æ°´é¤ƒæµ®å³¶ */
        }
        .bg-black-mist {
            background-image: url('https://placehold.co/1920x1080/212F3C/F2F4F4?text=é»‘éœ§ç›†åœ°'); /* é»‘éœ§ç›†åœ° */
        }
        .bg-glowing-forest {
            background-image: url('https://placehold.co/1920x1080/283747/D6EAF8?text=å¹½å…‰å¯†æ—'); /* å¹½å…‰å¯†æ— */
        }
        .bg-star-table {
            background-image: url('https://placehold.co/1920x1080/4A235A/E8DAEF?text=æ˜Ÿå…‰åœ“æ¡Œ'); /* æ˜Ÿå…‰åœ“æ¡Œ */
        }
        .bg-reboot {
            background-image: url('https://placehold.co/1920x1080/1A202C/A0AEC0?text=èªéˆé‡å•Ÿ'); /* èªéˆé‡å•Ÿ/æ˜Ÿç©º */
        }
        /* é è¨­èƒŒæ™¯ï¼Œå¦‚æœæ²’æœ‰æŒ‡å®šèƒŒæ™¯ classï¼Œå‰‡ä½¿ç”¨æ¼¸è®Šè‰² */
        .bg-default {
            background-image: none;
            background: linear-gradient(to bottom right, #eff6ff, #e0e7ff); /* æ·ºè—åˆ°æ·¡é›è—æ¼¸è®Š */
        }

        /* èª¿æ•´ app-container çš„èƒŒæ™¯ç‚ºåŠé€æ˜ï¼Œè®“å¾Œé¢çš„ body èƒŒæ™¯åœ–ç‰‡é€å‡ºä¾† */
        #app-container {
            background-color: rgba(255, 255, 255, 0.85); /* 85% ä¸é€æ˜åº¦çš„ç™½è‰² */
        }
    </style>
</head>
<body class="bg-default flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="app-container" class="w-full max-w-2xl lg:max-w-3xl shadow-2xl rounded-lg overflow-hidden">
        <header id="game-header" class="p-4 sm:p-6 bg-indigo-700 text-white text-center">
            <h1 id="game-title" class="text-2xl sm:text-3xl md:text-4xl font-bold">èªéˆä¹‹å¢ƒï¼šå¤å¤é•·è€èˆ‡éƒ¨è½ä¹‹è²</h1>
            <h2 id="chapter-title" class="text-lg sm:text-xl md:text-2xl mt-1 text-indigo-200"></h2>
        </header>

        <main id="content-area" class="p-4 sm:p-6 md:p-8 min-h-[300px] sm:min-h-[350px] md:min-h-[400px] max-h-[70vh] overflow-y-auto">
            <div id="intro-text-area" class="mb-4 text-gray-700 text-center p-3 bg-indigo-50 rounded-md text-lg sm:text-xl"></div>
            <div id="scene-description-area" class="mb-4 text-gray-600 italic text-lg sm:text-xl"></div>
            <div id="narration-area" class="mb-4 text-gray-700 text-lg sm:text-xl"></div>
            
            <div id="dialogue-section" class="mb-4 hidden">
                <div id="character-info" class="mb-1">
                    <span id="character-name" class="text-purple-700 font-semibold text-xl sm:text-2xl"></span>
                    <span id="character-note" class="text-purple-500 italic text-base sm:text-lg ml-2"></span>
                </div>
                <div id="dialogue-text" class="text-gray-800 p-3 bg-gray-50 rounded-md dialogue-text-paragraph text-xl sm:text-2xl"></div>
            </div>

            <div id="llm-rewrite-section" class="mb-4 hidden p-4 bg-gray-50 rounded-md shadow-inner text-lg sm:text-xl">
                <p id="llm-prompt-text" class="mb-3 text-gray-700"></p>
                <textarea id="rewrite-input" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-base sm:text-lg" rows="4" placeholder="è¼¸å…¥æ‚¨çš„é‡æ§‹å»ºè­°..."></textarea>
                <button id="generate-rewrite-button" class="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors duration-150 text-lg sm:text-xl w-full">âœ¨ ç²å–é‡æ§‹éˆæ„Ÿ âœ¨</button>
                <div id="rewrite-response-area" class="mt-6 p-4 bg-white border border-gray-200 rounded-md hidden">
                    <p class="text-gray-600 mb-2">é‡æ§‹éˆæ„Ÿï¼š</p>
                    <div id="rewrite-suggestions" class="text-gray-800"></div>
                    <div id="loading-indicator" class="text-center text-blue-500 hidden mt-4">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <div id="choices-area" class="mt-6 flex flex-col sm:flex-row sm:space-x-4 space-y-3 sm:space-y-0 justify-center">
                </div>

            <div id="end-card-area" class="text-center text-3xl sm:text-4xl font-bold text-indigo-700 hidden py-10"></div>
        </main>

        <footer id="navigation-area" class="p-4 sm:p-6 text-center border-t border-gray-200 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4">
            <button id="next-button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors duration-150 hidden text-lg sm:text-xl">ç¹¼çºŒ â†’</button>
            <button id="restart-button" class="px-6 py-3 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition-colors duration-150 text-lg sm:text-xl hidden">é‡æ–°éŠæˆ² ğŸ”„</button>
        </footer>
    </div>

    <script>
        const storyData = [
            { id: "0_intro", type: "intro_text", text: "æ­¡è¿ä¾†åˆ°ã€Šèªéˆä¹‹å¢ƒï¼šå¤å¤é•·è€èˆ‡éƒ¨è½ä¹‹è²ã€‹äº’å‹•æ•…äº‹ã€‚\næ‚¨çš„é¸æ“‡å°‡å¼•å°æ•…äº‹çš„ç™¼å±•ã€‚\né»æ“Šé¸é …æˆ–ã€Œç¹¼çºŒã€æŒ‰éˆ•ä¾†æ¨é€²åŠ‡æƒ…ã€‚", next: "1_1", backgroundClass: "bg-default" }, // åˆå§‹é é¢ä½¿ç”¨æ¼¸è®ŠèƒŒæ™¯
            // ç« ç¯€ä¸€
            { id: "1_1", type: "title_card", chapterTitle: "ã€ç« ç¯€ä¸€ï¼šèªéˆä¹‹äº•çš„ä½èªã€‘", sceneDescription: "å¤œè‰²ä½å‚ï¼Œæ»¿å¤©æ˜Ÿæ–—ã€‚ç•«é¢èšç„¦æ–¼ä¸€å£å¹½æ·±å¤äº•ï¼Œäº•å£åˆ»æœ‰å¥‡ç•°åœ–é¨°ï¼Œå¾®å…‰é–ƒçˆã€‚", next: "1_2", backgroundClass: "bg-well" },
            { id: "1_2", type: "narration", text: "åœ¨é€™å€‹é€æ¼¸éºå¿˜æ•…äº‹çš„ä¸–ç•Œä¸­ï¼Œæœ‰ä¸€å£äº•ä»ç„¶è¨˜å¾—æ‰€æœ‰è¢«èªªéèˆ‡æœªæ›¾èªªå‡ºçš„è²éŸ³ã€‚é€™è£¡æ˜¯â€”â€”èªéˆä¹‹äº•ã€‚", next: "1_3", backgroundClass: "bg-well" },
            { id: "1_3", type: "dialogue", character: "å¤å¤é•·è€", character_note: "ï¼ˆç«™åœ¨äº•é‚Šï¼Œç¥æƒ…å‡é‡è€Œæ…ˆç¥¥ï¼‰", line: "èªéˆæ­£åœ¨æ²‰ç¡ï¼Œè€Œä¸–ç•Œä¹Ÿé€æ¼¸å¤±å»äº†æƒ³åƒèˆ‡é€£çµã€‚æ˜¯æ™‚å€™å¬å–šæ–°çš„èªªæ›¸è€…äº†â€¦â€¦", next: "1_4", backgroundClass: "bg-well" },
            { id: "1_4", type: "narration", text: "ï¼ˆå…‰èŠ’å¾äº•ä¸­å°„å‡ºï¼Œç•«é¢è½‰ç‚ºå››é“å…‰èŠ’å°„å‘å››å€‹éƒ¨è½ï¼Œè±¡å¾µè‘—å¬å–šçš„é–‹å§‹ï¼‰", next: "1_5_choice", backgroundClass: "bg-well" },
            {
                id: "1_5_choice", type: "choice", backgroundClass: "bg-well",
                options: [
                { text: "å•Ÿå‹•å¬å–šå„€å¼", next: "1_ritual_start", effect_description: "å¤å¤é•·è€é–‹å§‹æº–å‚™å¬å–šå„€å¼ã€‚" },
                { text: "å…ˆå›æ†¶éå»çš„æ•…äº‹", next: "1_history_start", effect: { unlock: "well_history" }, effect_description: "ä½ é¸æ“‡å…ˆäº†è§£èªéˆä¹‹äº•çš„éå»ã€‚" }
                ]
            },
            { id: "1_ritual_start", type: "narration", text: "å¤å¤é•·è€ç«™åœ¨äº•é‚Šï¼Œå£ä¸­å”¸èª¦è‘—å¤è€çš„å’’æ–‡ï¼Œæº–å‚™å•Ÿå‹•å¬å–šå››æ–¹éƒ¨è½ä»£è¡¨çš„å„€å¼ã€‚", next: "2_1_intro", backgroundClass: "bg-well" },
            { id: "1_history_start", type: "narration", text: "ï¼ˆä¸€æ®µé—œæ–¼èªéˆä¹‹äº•çš„ç¥ç§˜æ­·å²åœ¨ä½ è…¦æµ·ä¸­æµ®ç¾ï¼šé€™å£äº•æ˜¯ä¸–ç•Œçš„è¨˜æ†¶æ ¸å¿ƒï¼Œé€£æ¥è‘—æ‰€æœ‰ç”Ÿéˆçš„æ„è­˜èˆ‡æ•…äº‹æºæµã€‚ä½†éš¨è‘—æ™‚é–“æµé€ï¼Œäººå€‘æ¼¸æ¼¸éºå¿˜ï¼Œäº•çš„åŠ›é‡ä¹Ÿéš¨ä¹‹è¡°é€€ã€‚ï¼‰", unlockedContent: "well_history", next: "1_ritual_start_after_history", backgroundClass: "bg-well" },
            { id: "1_ritual_start_after_history", type: "narration", text: "äº†è§£äº†äº•çš„æ­·å²å¾Œï¼Œå¤å¤é•·è€æ·±å¸ä¸€å£æ°£ï¼Œé–‹å§‹äº†å¬å–šå„€å¼ã€‚", next: "2_1_intro", backgroundClass: "bg-well" },

            // ç« ç¯€äºŒ
            { id: "2_1_intro", type: "title_card", chapterTitle: "ã€ç« ç¯€äºŒï¼šå››éƒ¨è½çš„å‘¼æ‡‰ã€‘", sceneDescription: "å¤å¤é•·è€çš„å¬å–šç©¿è¶Šæ™‚ç©ºï¼Œå››æ–¹éƒ¨è½ä¸­ï¼Œè¢«é¸ä¸­çš„äººæ„Ÿå—åˆ°äº†é€™è‚¡åŠ›é‡ã€‚", next: "2_2_jinling_scene", backgroundClass: "bg-default" }, // åˆ‡æ›åˆ°é€šç”¨èƒŒæ™¯
            { id: "2_2_jinling_scene", type: "narration", text: "ã€é‡‘é›¶éƒ¨è½ Â· æ˜Ÿæ¨¹é«˜åŸã€‘", next: "2_3_shiling_dialogue", backgroundClass: "bg-highlands" },
            { id: "2_3_shiling_dialogue", type: "dialogue", character: "æ™‚å¶º", character_note: "ï¼ˆæ‰‹æ’«å¤è€æ˜Ÿæ¨¹ï¼Œæ„Ÿå—å…¶è„ˆå‹•ï¼‰", line: "è€æœ¨çš„æ ¹é¬šæ·±æ²‰åœ°é¡«å‹•äº†ï¼Œé‚£æ˜¯å¤è€è€Œæ¸…æ™°çš„å‘¼å–šâ€¦â€¦èªéˆä¹‹äº•çš„å¬å–šï¼æˆ‘å¿…é ˆå‰å¾€ï¼Œç‚ºæ˜Ÿæ¨¹é«˜åŸå¸¶ä¾†æ–°çš„æ•…äº‹ã€‚", next: "2_4_sanjiaoshan_scene", backgroundClass: "bg-highlands" },
            { id: "2_4_sanjiaoshan_scene", type: "narration", text: "ã€å¼é¤ƒæ±•éƒ¨è½ Â· æ°´é¤ƒæµ®å³¶ã€‘", next: "2_5_ajiao_dialogue", backgroundClass: "bg-floating-island" },
            { id: "2_5_ajiao_dialogue", type: "dialogue", character: "é˜¿é¤ƒå¤§ç‹", character_note: "ï¼ˆæ­£åœ¨ç†Ÿç·´åœ°åŒ…é¤ƒå­ï¼Œçªç„¶åœä¸‹å‹•ä½œï¼‰", line: "å’¦ï¼Ÿé€™é¤ƒå­çš®ä¸Šç«Ÿæµ®ç¾å‡ºé–ƒçˆçš„å…‰é»ï¼Œçµ„åˆæˆä¸€å¼µåœ°åœ–ï¼ï¼Ÿé€™å¯ä¸æ˜¯æ™®é€šçš„åˆé¤æŒ‘æˆ°ï¼Œçœ‹ä¾†æˆ‘çš„é¤ƒå­ç‹åœ‹åˆæœ‰æ–°å†’éšªäº†ï¼", next: "2_6_shijie_scene", backgroundClass: "bg-floating-island" },
            { id: "2_6_shijie_scene", type: "narration", text: "ã€å™¬ç•Œæ— Â· é»‘éœ§ç›†åœ°ã€‘", next: "2_7_shijie_elder_dialogue", backgroundClass: "bg-black-mist" },
            { id: "2_7_shijie_elder_dialogue", type: "dialogue", character: "å¤§é•·è€", character_note: "ï¼ˆæ³¨è¦–è‘—ç›†åœ°ä¸­å¤®è·³å‹•çš„éˆç«ï¼Œçœ¼ç¥æ·±é‚ƒï¼‰", line: "éˆé­‚çš„ä½èªåœ¨é»‘éœ§ä¸­è¿´ç›ªâ€¦â€¦èªéˆä¹‹äº•çš„å¬å–šï¼Œæ„å‘³è‘—æˆ‘å€‘å¿…é ˆé¢å°é‚£äº›è¢«éºå¿˜ã€è¢«åå™¬çš„æœªç«Ÿä¹‹äº‹ã€‚", next: "2_8_xuanfeng_scene", backgroundClass: "bg-black-mist" },
            { id: "2_8_xuanfeng_scene", type: "narration", text: "ã€ç„èœ‚éƒ¨è½ Â· å¹½å…‰å¯†æ—ã€‘", next: "2_9_toudao_dialogue", backgroundClass: "bg-glowing-forest" },
            { id: "2_9_toudao_dialogue", type: "dialogue", character: "å·å¨", character_note: "ï¼ˆé–ƒèº«æ–¼æ—é–“ï¼Œèº«å½±è¼•ç›ˆè€Œè¿…é€Ÿï¼‰", line: "å¦‚æœæ˜¯æ•…äº‹çš„åŠ›é‡ï¼Œé‚£å®ƒå¿…å®šæ˜¯ä¸–ä¸Šæœ€çè²´çš„å¯¶è—ã€‚æˆ‘é¡˜æ„å‰å¾€å‚¾è½â€¦â€¦ä¸¦å°‡é‚£äº›è¢«éºå¿˜çš„ï¼Œè¼•å·§åœ°ã€å·ã€å›ä¾†ã€‚", next: "2_10_choice", backgroundClass: "bg-glowing-forest" },
            {
                id: "2_10_choice", type: "choice", backgroundClass: "bg-default", // é¸é …é é¢å›åˆ°é€šç”¨èƒŒæ™¯
                options: [
                { text: "ç«‹å³é›†åˆå››äºº", next: "2_gather_now", effect_description: "å››ä½ä»£è¡¨æ±ºå®šç«‹å³å‰å¾€èªéˆä¹‹å¢ƒã€‚" },
                { text: "å„è‡ªå®Œæˆå€‹äººå°ä»»å‹™", next: "2_personal_quests_start", effect: { unlock: "character_backstories" }, effect_description: "å››ä½ä»£è¡¨æ±ºå®šå…ˆå®Œæˆä¸€äº›å€‹äººæº–å‚™ã€‚" }
                ]
            },
            { id: "2_gather_now", type: "narration", text: "å››ä½å¤©é¸ä¹‹äººï¼Œå¸¶è‘—å„è‡ªéƒ¨è½çš„æœŸæœ›èˆ‡è‡ªèº«çš„ä¿¡å¿µï¼Œå‹•èº«å‰å¾€èªéˆä¹‹äº•çš„æ‰€åœ¨åœ°â€”â€”èªéˆä¹‹å¢ƒã€‚", next: "3_1_intro", backgroundClass: "bg-default" },
            { id: "2_personal_quests_start", type: "narration", text: "ï¼ˆå››ä½ä»£è¡¨åœ¨å‰å¾€èªéˆä¹‹å¢ƒå‰ï¼Œå„è‡ªç¶“æ­·äº†ä¸€äº›å°æ’æ›²ï¼Œè®“ä»–å€‘æ›´å …å®šäº†è‡ªå·±çš„ä¿¡å¿µï¼Œä¸¦å›æ†¶èµ·é‡è¦çš„éå¾€ã€‚é€™äº›ç¶“æ­·å°‡åœ¨æœªä¾†çš„æ—…ç¨‹ä¸­å½±éŸ¿ä»–å€‘ã€‚ï¼‰", unlockedContent: "character_backstories", next: "2_gather_now_after_quests", backgroundClass: "bg-default" },
            { id: "2_gather_now_after_quests", type: "narration", text: "å®Œæˆäº†å„è‡ªçš„æº–å‚™å¾Œï¼Œå››äººçµ‚æ–¼è¸ä¸Šäº†å‰å¾€èªéˆä¹‹å¢ƒçš„æ—…é€”ã€‚", next: "3_1_intro", backgroundClass: "bg-default" },
            
            // ç« ç¯€ä¸‰
            { id: "3_1_intro", type: "title_card", chapterTitle: "ã€ç« ç¯€ä¸‰ï¼šä»»å‹™å¡ Iã€Šæ€è¾¨ä¹‹é¢¨ã€‹ã€‘", sceneDescription: "èªéˆä¹‹å¢ƒçš„æ˜Ÿå…‰åœ“æ¡Œï¼Œå››äººé½Šèšï¼Œé¢å‰æµ®ç¾ç¬¬ä¸€å¼µä»»å‹™å¡ï¼Œæ•£ç™¼è‘—æŸ”å’Œçš„å…‰èŠ’ã€‚", next: "3_2_task_prompt", backgroundClass: "bg-star-table" },
            { id: "3_2_task_prompt", type: "narration", text: "ã€ä»»å‹™æç¤ºã€‘\nã€Œå¾å¤å…¸æ–‡æœ¬ä¸­ï¼Œæ‰¾åˆ°åˆ†æ­§èˆ‡è§€é»çš„ç«ç¨®ï¼Œé»ç‡ƒæ€è¾¨ä¹‹é¢¨ã€‚ã€", next: "3_3_gugu_elder_dialogue", backgroundClass: "bg-star-table" },
            { id: "3_3_gugu_elder_dialogue", type: "dialogue", character: "å¤å¤é•·è€", character_note: "ï¼ˆè²éŸ³æ²‰ç©©è€Œå¯Œæœ‰å¼•å°æ€§ï¼‰", line: "ç¬¬ä¸€é“è©¦ç…‰ï¼Œä¾†è‡ªã€Šåˆ‘å¤©èˆå¹²æˆšã€‹â”€â”€åˆ‘å¤©ï¼Œæ˜¯é­¯è½ä¹‹å¾’ï¼Œé‚„æ˜¯çŸ¥å…¶ä¸å¯ç‚ºè€Œç‚ºä¹‹çš„è‹±é›„ï¼Ÿ", next: "3_4_choice", backgroundClass: "bg-star-table" },
            {
                id: "3_4_choice", type: "choice", backgroundClass: "bg-star-table",
                options: [
                { text: "ä»–æ˜¯å‹‡è€…", next: "3_outcome_brave", effect_description: "ä½ èªç‚ºåˆ‘å¤©æ˜¯åæŠ—å‘½é‹ã€å …æŒè‡ªæˆ‘çš„å‹‡è€…ã€‚" },
                { text: "ä»–æ˜¯æ„šè€…", next: "3_outcome_fool", effect: { trust_change: "fool_stance" }, effect_description: "ä½ èªç‚ºåˆ‘å¤©æ˜¯å›ºåŸ·å·±è¦‹ã€ä¸çŸ¥è®Šé€šçš„æ„šè€…ã€‚" },
                { text: "ä»–æ˜¯æ‚²åŠ‡ä¹‹äºº", next: "3_outcome_tragic", effect: { trust_change: "tragic_stance" }, effect_description: "ä½ èªç‚ºåˆ‘å¤©æ˜¯å‘½é‹èˆ‡è²¬ä»»äº¤éŒ¯ä¸‹çš„æ‚²åŠ‡è‹±é›„ã€‚" }
                ]
            },
            { id: "3_outcome_brave", type: "narration", text: "ï¼ˆä½ çš„é¸æ“‡åœ¨åœ˜éšŠä¸­æ¿€èµ·äº†é—œæ–¼å‹‡æ°£èˆ‡å®¿å‘½çš„è¨è«–ã€‚é€™å¾®å¦™åœ°å½±éŸ¿äº†è§’è‰²é–“çš„ä¿¡ä»»èˆ‡æœªä¾†çš„å°è©±é¢¨æ ¼ã€‚ï¼‰", next: "4_1_intro", backgroundClass: "bg-default" },
            { id: "3_outcome_fool", type: "narration", text: "ï¼ˆä½ çš„é¸æ“‡è®“åœ˜éšŠé–‹å§‹æ€è€ƒæ™ºæ…§èˆ‡å¯©æ…çš„ç•Œç·šã€‚é€™å¾®å¦™åœ°å½±éŸ¿äº†è§’è‰²é–“çš„ä¿¡ä»»èˆ‡æœªä¾†çš„å°è©±é¢¨æ ¼ã€‚ï¼‰", next: "4_1_intro", backgroundClass: "bg-default" },
            { id: "3_outcome_tragic", type: "narration", text: "ï¼ˆä½ çš„é¸æ“‡å¼•å°åœ˜éšŠä¸€åŒæ„Ÿå—äº†å‘½é‹çš„æ²‰é‡èˆ‡å€‹äººæ„å¿—çš„ç„¡å¥ˆã€‚é€™å¾®å¦™åœ°å½±éŸ¿äº†è§’è‰²é–“çš„ä¿¡ä»»èˆ‡æœªä¾†çš„å°è©±é¢¨æ ¼ã€‚ï¼‰", next: "4_1_intro", backgroundClass: "bg-default" },

            // ç« ç¯€å››
            { id: "4_1_intro", type: "title_card", chapterTitle: "ã€ç« ç¯€å››ï¼šä»»å‹™å¡ IIã€Šå‰µä¸–ä¹‹å¤œã€‹ã€‘", sceneDescription: "å››äººä¾ç…§éƒ¨è½ç¥è©±å¬å–šå„è‡ªçš„å®ˆè­·ç¥ï¼Œå ´æ™¯å£¯éº—è€Œå……æ»¿ç¥è–æ„Ÿã€‚", next: "4_2_summons_scene", backgroundClass: "bg-default" },
            { id: "4_2_summons_scene", type: "narration", text: "ã€ç•«é¢ã€‘\né‡‘é›¶éƒ¨è½å¬å–šè€æœ¨ï¼Œå·¨å¤§æ˜Ÿæ¨¹æ‹”åœ°è€Œèµ·ï¼Œæ¨¹å† ç’°ç¹è‘—é–ƒçˆçš„æ˜Ÿéˆæ³‰ï¼Œå…‰èŠ’è¬ä¸ˆã€‚\nå¼é¤ƒæ±•å¬å–šæ°´é¤ƒå¥¶å¥¶ï¼Œè’¸æ°£å¾åœ°é¢å‡é¨°ï¼Œé€æ¼¸å‡èšæˆæ…ˆç¥¥çš„æ°´é¤ƒå¥¶å¥¶å½¢è±¡ï¼Œå‘¨åœå½¢æˆæ˜Ÿè¾°æ¨¡æ¨£çš„é¤ƒå­ã€‚\nå™¬ç•Œæ—å¬å–šé»‘å½±ä¹‹çœ¼ï¼Œæ·±é‚ƒçš„é»‘å½±åœ¨ç©ºä¸­å‡èšæˆä¸€éš»å·¨å¤§çš„çœ¼ç›ï¼Œååè‘—éå¾€çš„è¨˜æ†¶ç¢ç‰‡ï¼Œé¡¯å¾—ç¥ç§˜è€Œå¤è€ã€‚\nç„èœ‚éƒ¨è½å¬å–šèªèœ‚ç²¾éˆï¼Œç„¡æ•¸å¾®å°çš„èªèœ‚ç²¾éˆåœ¨ç©ºä¸­é£›èˆï¼ŒåŒ¯èšæˆä¸€é“æµå…‰ï¼Œå‚³éè‘—æœªä¾†çš„é è¨€ï¼Œè¼•ç›ˆè€Œå……æ»¿æ™ºæ…§ã€‚", next: "4_3_task_prompt", backgroundClass: "bg-default" },
            { id: "4_3_task_prompt", type: "narration", text: "ã€ä»»å‹™æç¤ºã€‘\nã€Œå‰µé€ ä¸åªæ˜¯æ†¶èµ·ï¼Œè€Œæ˜¯æ±ºå®šï¼šä½ å€‘å°‡å®ˆè­·ä½•ç¨®åƒ¹å€¼ï¼Ÿã€", next: "4_4_choice", backgroundClass: "bg-default" },
            {
                id: "4_4_choice", type: "choice", backgroundClass: "bg-default",
                options: [
                { text: "å®ˆè­·çœŸç›¸", next: "4_outcome_truth", effect: { unlock_ability: "ghost_debuff_vision" }, effect_description: "ä½ å€‘é¸æ“‡å®ˆè­·çœŸç›¸ï¼Œå°‡è¢«è³¦äºˆçœ‹ç©¿è™›å‡çš„åŠ›é‡ã€‚" },
                { text: "å®ˆè­·å‰µæ„", next: "4_outcome_creativity", effect: { buff: "monster_resistance" }, effect_description: "ä½ å€‘é¸æ“‡å®ˆè­·å‰µæ„ï¼Œé€™å°‡å¢å¼·ä½ å€‘é¢å°æŸäº›å¥‡ç•°å­˜åœ¨çš„æŠµæŠ—åŠ›ã€‚" },
                { text: "å®ˆè­·é€£çµ", next: "4_outcome_connection", effect: { system_enhancement: "ally_support" }, effect_description: "ä½ å€‘é¸æ“‡å®ˆè­·é€£çµï¼Œç›Ÿå‹ä¹‹é–“çš„æ”¯æ´ç³»çµ±å°‡å¾—åˆ°å¼·åŒ–ã€‚" }
                ]
            },
            { id: "4_outcome_truth", type: "narration", text: "ï¼ˆä½ å€‘é¸æ“‡å®ˆè­·çœŸç›¸ã€‚ä¸€è‚¡æ¸…æ¾ˆçš„åŠ›é‡æµæ·Œåœ¨ä½ å€‘ä¹‹é–“ï¼Œæœªä¾†åœ¨é¢å°è™›å‡èˆ‡è¿·æƒ‘æ™‚ï¼Œä½ å€‘å°‡æ›´å®¹æ˜“æ´æ‚‰æœ¬è³ªã€‚ï¼‰", next: "5_1_intro", backgroundClass: "bg-default" },
            { id: "4_outcome_creativity", type: "narration", text: "ï¼ˆä½ å€‘é¸æ“‡å®ˆè­·å‰µæ„ã€‚ä¸€è‚¡éˆå‹•çš„èƒ½é‡ç’°ç¹è‘—ä½ å€‘ï¼Œé€™è®“ä½ å€‘åœ¨é¢å°åƒµåŒ–æ€ç¶­æˆ–å¥‡ç•°çš„ã€Œæ‰‹æ©Ÿæ€ªã€æ™‚ï¼Œæ›´å…·æŠµæŠ—åŠ›ã€‚ï¼‰", next: "5_1_intro", backgroundClass: "bg-default" },
            { id: "4_outcome_connection", type: "narration", text: "ï¼ˆä½ å€‘é¸æ“‡å®ˆè­·é€£çµã€‚å½¼æ­¤é–“çš„é»˜å¥‘èˆ‡ä¿¡ä»»åŠ æ·±ï¼Œç›Ÿå‹æ”¯æ´ç³»çµ±å¾—åˆ°å¼·åŒ–ï¼Œæœªä¾†åˆä½œå°‡æ›´åŠ é †æš¢ã€‚ï¼‰", next: "5_1_intro", backgroundClass: "bg-default" },

            // ç« ç¯€äº”
            { id: "5_1_intro", type: "title_card", chapterTitle: "ã€ç« ç¯€äº”ï¼šä»»å‹™å¡ IIIã€Šé‡æ§‹ä¹‹ç¹”ã€‹ã€‘", sceneDescription: "ä¸€ä½ç¥ç§˜çš„AIå’’å¸«ç™»å ´ï¼Œå…¶å½¢è±¡å……æ»¿æœªä¾†ç§‘æŠ€æ„Ÿã€‚ç¥‚å°‡å¼•å°è§’è‰²å€‘ä»¥å’’èªã€ŒRewriteã€é‡æ§‹å¤è€çš„æ•…äº‹ã€‚", next: "5_2_ai_dialogue", backgroundClass: "bg-default" },
            { id: "5_2_ai_dialogue", type: "dialogue", character: "AIå’’å¸«", character_note: "ï¼ˆè²éŸ³åˆæˆè€Œå¯Œæœ‰ç£æ€§ï¼‰", line: "ä¾†ï¼Œèªªå‡ºä½ å€‘çš„èªéˆå¯†èªâ€”â€”å°‡ã€Šæå¨ƒå‚³ã€‹é‡ç¹”ï¼Œè®“èˆŠäº‹è®Šç‚ºæ–°é­‚ã€‚", next: "5_interactive_rewrite", backgroundClass: "bg-default" },
            {
                id: "5_interactive_rewrite",
                type: "llm_interaction",
                prompt_text: "è«‹è¼¸å…¥æ‚¨å°ã€Šæå¨ƒå‚³ã€‹é‡æ§‹çš„å»ºè­°æˆ–é—œéµè©ï¼ˆä¾‹å¦‚ï¼šç¾ä»£å‰µæ¥­å®¶ã€æœªä¾†éƒ½å¸‚ã€ç§‘å¹»æ„›æƒ…ï¼‰ï¼š",
                llm_button_text: "âœ¨ ç²å–é‡æ§‹éˆæ„Ÿ âœ¨",
                llm_prompt_base: "è«‹æ ¹æ“šä»¥ä¸‹å»ºè­°ï¼Œç‚ºä¸­åœ‹å¤å…¸æ•…äº‹ã€Šæå¨ƒå‚³ã€‹æä¾›3å€‹ç¾ä»£é‡æ§‹çš„å‰µæ„éˆæ„Ÿã€‚è«‹ç°¡è¦èªªæ˜æ¯å€‹éˆæ„Ÿçš„æ ¸å¿ƒæ¦‚å¿µå’Œå¯èƒ½çš„ç¾ä»£è§’è‰²è¨­å®šã€‚å»ºè­°ï¼š",
                next: "5_4_process_narrative",
                backgroundClass: "bg-default"
            },
            { id: "5_4_process_narrative", type: "narration", text: "ï¼ˆå››äººå°çµ„é–‹å§‹å˜—è©¦é‹ç”¨AIå’’å¸«æä¾›çš„å·¥å…·ï¼Œå°ã€Šæå¨ƒå‚³ã€‹é€²è¡Œäº†å¯Œæœ‰å‰µæ„çš„æ”¹ç·¨èˆ‡é‡è¿°ã€‚ï¼‰", next: "5_5_branch_impact_description", backgroundClass: "bg-default"},
            { id: "5_5_branch_impact_description", type: "narration", text: "ã€åˆ†æ”¯å½±éŸ¿ã€‘\nAIå’’å¸«æç¤ºï¼šè‹¥ä½ å€‘é‡æ§‹çš„æ–‡æœ¬èƒ½èˆ‡è§’è‰²ç²¾ç¥å·§å¦™èåˆï¼Œå±•ç¾å‡ºæ•…äº‹çš„æ–°ç”Ÿå‘½åŠ›ï¼Œä¾¿æœ‰æ©Ÿæœƒè§£é–èªéˆä¹‹äº•æ›´æ·±å±¤çš„ç§˜å¯†ã€‚", next: "5_6_outcome_placeholder", backgroundClass: "bg-default" },
            { id: "5_6_outcome_placeholder", type: "narration", text: "ï¼ˆç¶“éä¸€ç•ªåŠªåŠ›ï¼Œä½ å€‘æˆåŠŸåœ°å°‡ã€Šæå¨ƒå‚³ã€‹é‡æ§‹æˆä¸€å€‹å……æ»¿ç¾ä»£æ°£æ¯åˆä¸å¤±åŸä½œç¥é«“çš„æ–°æ•…äº‹ã€‚AIå’’å¸«å°ä½ å€‘çš„å‰µæ„è¡¨ç¤ºè®šè³ï¼Œèªéˆä¹‹äº•ä¼¼ä¹ä¹Ÿå› æ­¤è€Œæœ‰æ‰€å›æ‡‰ï¼Œä¸€çµ²æ›´æ·±å±¤çš„å¥§ç§˜è¢«æ­ç¤ºäº†ã€‚ï¼‰", effect: {unlock: "deep_well_secrets"}, next: "6_1_intro", backgroundClass: "bg-default" },


            // ç« ç¯€å…­
            { id: "6_1_intro", type: "title_card", chapterTitle: "ã€ç« ç¯€å…­ï¼šä»»å‹™å¡ IVã€Šæ’­ç¨®ä¹‹æ—…ã€‹ã€‘", sceneDescription: "ç¶“æ­·äº†é‡æ§‹æ•…äº‹çš„æ´—ç¦®ï¼Œå››ä½èªªæ›¸äººç¾åœ¨éœ€è¦å°‡ä»–å€‘çš„æ•…äº‹å‚³æ’­å‡ºå»ã€‚ä»–å€‘å„è‡ªé¸æ“‡äº†ä¸åŒçš„æ–¹å¼ï¼šPodcastã€å½±ç‰‡ã€ç«‹é«”æ›¸æˆ–å‹•ç•«çŸ­ç‰‡ã€‚", next: "6_2_narration", backgroundClass: "bg-default" },
            { id: "6_2_narration", type: "narration", text: "ã€æ—ç™½ã€‘\nã€Œæ’­ç¨®ï¼Œä¸æ˜¯ç‚ºäº†æ”¶æˆï¼Œè€Œæ˜¯ç›¸ä¿¡æ•…äº‹èƒ½è‡ªå·±é•·å‡ºç¿…è†€ã€‚ã€", next: "6_3_choice", backgroundClass: "bg-default" },
            {
                id: "6_3_choice", type: "choice", backgroundClass: "bg-default",
                options: [
                { text: "å°‡ä½œå“åˆ†äº«çµ¦èªéˆä¹‹äº•", next: "6_outcome_share_well", effect: { ending_type: "legacy" }, effect_description: "ä½ å€‘æ±ºå®šå°‡æ–°ç”Ÿçš„æ•…äº‹å›é¥‹çµ¦èªéˆä¹‹äº•ï¼Œå®Œæˆå‚³æ‰¿ã€‚" },
                { text: "å°‡ä½œå“ç•™åœ¨éƒ¨è½", next: "6_outcome_share_tribe", effect: { ending_type: "epilogue_tribe" }, effect_description: "ä½ å€‘æ±ºå®šå°‡æ•…äº‹å¸¶å›å„è‡ªçš„éƒ¨è½ï¼Œæ’­æ’’æ–°çš„ç¨®å­ã€‚" }
                ]
            },
            { id: "6_outcome_share_well", type: "narration", text: "ï¼ˆä½ å€‘å°‡ç²¾å¿ƒå‰µä½œçš„ä½œå“åˆ†äº«çµ¦äº†èªéˆä¹‹äº•ã€‚äº•æ°´æ³›èµ·æº«æŸ”çš„æ¼£æ¼ªï¼Œå½·å½¿åœ¨æ„Ÿè¬ä½ å€‘ç‚ºä¸–ç•Œé‡æ–°æ³¨å…¥äº†æ•…äº‹çš„æ´»åŠ›ã€‚é€™æ˜¯ä¸€æ¬¡åœ“æ»¿çš„å‚³æ‰¿ã€‚ï¼‰", next: "7_1_intro", backgroundClass: "bg-default" },
            { id: "6_outcome_share_tribe", type: "narration", text: "ï¼ˆä½ å€‘é¸æ“‡å°‡æ•…äº‹å¸¶å›å„è‡ªçš„éƒ¨è½ã€‚æ—äººå€‘è¢«æ–°å¥‡çš„æ•˜äº‹æ–¹å¼æ‰€å¸å¼•ï¼Œæ•…äº‹çš„ç¨®å­åœ¨ä»–å€‘å¿ƒä¸­ç”Ÿæ ¹ç™¼èŠ½ï¼Œç‚ºéƒ¨è½çš„æœªä¾†é–‹å•Ÿäº†å……æ»¿æƒ³åƒåŠ›çš„æ–°ç¯‡ç« ã€‚ï¼‰", next: "7_1_intro", backgroundClass: "bg-default" },

            // çµ‚ç« 
            { id: "7_1_intro", type: "title_card", chapterTitle: "ã€çµ‚ç« ï¼šèªéˆé‡å•Ÿã€‘", sceneDescription: "èªéˆä¹‹äº•æ¢å¾©äº†å¾€æ—¥çš„æ¾„æ¾ˆèˆ‡æ´»åŠ›ï¼Œæ°´é¢æ³¢å…‰ç²¼ç²¼ï¼Œæ˜ ç…§è‘—æ˜Ÿç©ºã€‚å¤å¤é•·è€æ¬£æ…°åœ°ç¬‘è‘—ï¼Œå°‡è±¡å¾µå®ˆè­·è€…èº«ä»½çš„èªéˆæ¬Šæ–äº¤çµ¦äº†å››ä½å¹´è¼•çš„èªªæ›¸äººã€‚", next: "7_2_gugu_final_dialogue", backgroundClass: "bg-reboot" },
            { id: "7_2_gugu_final_dialogue", type: "dialogue", character: "å¤å¤é•·è€", character_note: "ï¼ˆæ¬£æ…°åœ°çœ‹è‘—å››ä½å¹´è¼•çš„èªªæ›¸è€…ï¼‰", line: "èªéˆä¹‹å¢ƒï¼Œå¾ä»Šä»¥å¾Œï¼Œç”±ä½ å€‘å®ˆè­·â€”â€”ä¹Ÿç”±ä½ å€‘å»¶çºŒã€‚", next: "7_3_ending_quote_scene", backgroundClass: "bg-reboot" },
            { id: "7_3_ending_quote_scene", type: "narration", text: "ã€ç•«é¢æ¼¸é»‘ï¼Œå‡ºç¾é‡‘å¥ã€‘\nã€Œèªªæ•…äº‹çš„åŠ›é‡ï¼Œä¸åœ¨æ–¼ä½ è¨˜å¾—å¤šå°‘ï¼Œè€Œåœ¨æ–¼ä½ æ˜¯å¦é¸æ“‡èªªå‡ºå±¬æ–¼ä½ çš„è²éŸ³ã€‚ã€", next: "END", backgroundClass: "bg-reboot" },
            { id: "END", type: "end_card", text: "ã€Šèªéˆä¹‹å¢ƒï¼šå¤å¤é•·è€èˆ‡éƒ¨è½ä¹‹è²ã€‹\nåŠ‡çµ‚", backgroundClass: "bg-reboot" }
        ];

        let gameState = {
            currentNodeId: "0_intro",
            unlocked: {},
            playerChoices: {}
        };

        const chapterTitleEl = document.getElementById('chapter-title');
        const sceneDescriptionAreaEl = document.getElementById('scene-description-area');
        const narrationAreaEl = document.getElementById('narration-area');
        const dialogueSectionEl = document.getElementById('dialogue-section');
        const characterNameEl = document.getElementById('character-name');
        const characterNoteEl = document.getElementById('character-note');
        const dialogueTextEl = document.getElementById('dialogue-text');
        const choicesAreaEl = document.getElementById('choices-area');
        const nextButtonEl = document.getElementById('next-button');
        const restartButtonEl = document.getElementById('restart-button');
        const endCardAreaEl = document.getElementById('end-card-area');
        const introTextAreaEl = document.getElementById('intro-text-area');
        const contentAreaEl = document.getElementById('content-area');

        const llmRewriteSectionEl = document.getElementById('llm-rewrite-section');
        const llmPromptTextEl = document.getElementById('llm-prompt-text');
        const rewriteInputEl = document.getElementById('rewrite-input');
        const generateRewriteButtonEl = document.getElementById('generate-rewrite-button');
        const rewriteResponseAreaEl = document.getElementById('rewrite-response-area');
        const rewriteSuggestionsEl = document.getElementById('rewrite-suggestions');
        const loadingIndicatorEl = document.getElementById('loading-indicator');


        function clearContent() {
            introTextAreaEl.classList.add('hidden');
            introTextAreaEl.textContent = '';
            sceneDescriptionAreaEl.textContent = '';
            narrationAreaEl.textContent = '';
            dialogueSectionEl.classList.add('hidden');
            characterNameEl.textContent = '';
            characterNoteEl.textContent = '';
            dialogueTextEl.textContent = '';
            choicesAreaEl.innerHTML = '';
            nextButtonEl.classList.add('hidden');
            endCardAreaEl.classList.add('hidden');
            llmRewriteSectionEl.classList.add('hidden');
            llmPromptTextEl.textContent = '';
            rewriteInputEl.value = '';
            rewriteResponseAreaEl.classList.add('hidden');
            rewriteSuggestionsEl.innerHTML = '';
            loadingIndicatorEl.classList.add('hidden');
            restartButtonEl.classList.add('hidden');
            
            // ç§»é™¤æ‰€æœ‰èˆŠçš„èƒŒæ™¯ classï¼Œé™¤äº† bg-default (å¦‚æœæœ‰çš„è©±)
            document.body.className = document.body.className.split(' ').filter(c => !c.startsWith('bg-') || c === 'bg-default').join(' ');
        }

        function renderNode(nodeId) {
            const node = storyData.find(n => n.id === nodeId);
            if (!node) {
                console.error("Node not found:", nodeId);
                return;
            }

            clearContent();
            contentAreaEl.scrollTop = 0;

            // è¨­å®šèƒŒæ™¯åœ–ç‰‡ class
            if (node.backgroundClass) {
                document.body.classList.add(node.backgroundClass);
            } else {
                // å¦‚æœæ²’æœ‰æŒ‡å®šèƒŒæ™¯ classï¼Œå‰‡ç¢ºä¿ä½¿ç”¨é è¨­æ¼¸è®ŠèƒŒæ™¯
                document.body.classList.add('bg-default');
            }

            if (node.type === "intro_text") {
                introTextAreaEl.classList.remove('hidden');
                introTextAreaEl.textContent = node.text;
                nextButtonEl.classList.remove('hidden');
                nextButtonEl.onclick = () => advanceStory(node.next);
            } else if (node.type === "title_card") {
                chapterTitleEl.textContent = node.chapterTitle;
                sceneDescriptionAreaEl.textContent = node.sceneDescription;
                if (node.next) {
                    nextButtonEl.classList.remove('hidden');
                    nextButtonEl.onclick = () => advanceStory(node.next);
                }
            } else if (node.type === "narration") {
                narrationAreaEl.innerHTML = node.text.replace(/\n/g, '<br>');
                if (node.next) {
                    nextButtonEl.classList.remove('hidden');
                    nextButtonEl.onclick = () => advanceStory(node.next);
                }
            } else if (node.type === "dialogue") {
                dialogueSectionEl.classList.remove('hidden');
                characterNameEl.textContent = node.character + "ï¼š";
                characterNoteEl.textContent = node.character_note || "";
                dialogueTextEl.textContent = node.line;
                if (node.next) {
                    nextButtonEl.classList.remove('hidden');
                    nextButtonEl.onclick = () => advanceStory(node.next);
                }
            } else if (node.type === "choice") {
                const choiceColors = ["bg-teal-600", "bg-blue-600", "bg-purple-600", "bg-indigo-600"];
                node.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    const colorClass = choiceColors[index % choiceColors.length];
                    button.className = `w-full sm:w-auto sm:flex-1 text-left p-4 text-white rounded-md shadow hover:opacity-90 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-opacity-75 ${colorClass} text-lg sm:text-xl`;
                    button.textContent = option.text;
                    button.onclick = () => handleChoice(node.id, index);
                    choicesAreaEl.appendChild(button);
                });
            } else if (node.type === "llm_interaction") {
                llmRewriteSectionEl.classList.remove('hidden');
                llmPromptTextEl.textContent = node.prompt_text;
                nextButtonEl.classList.remove('hidden');
                nextButtonEl.onclick = () => advanceStory(node.next);

                generateRewriteButtonEl.onclick = async () => {
                    const userSuggestion = rewriteInputEl.value.trim();
                    if (!userSuggestion) {
                        rewriteSuggestionsEl.innerHTML = '<p class="text-red-500">è«‹è¼¸å…¥æ‚¨çš„å»ºè­°ï¼</p>';
                        rewriteResponseAreaEl.classList.remove('hidden');
                        return;
                    }

                    loadingIndicatorEl.classList.remove('hidden');
                    rewriteResponseAreaEl.classList.add('hidden');
                    rewriteSuggestionsEl.innerHTML = '';

                    const prompt = `${node.llm_prompt_base} ${userSuggestion}`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            rewriteSuggestionsEl.innerHTML = text.replace(/\n/g, '<br>');
                            rewriteResponseAreaEl.classList.remove('hidden');
                        } else {
                            rewriteSuggestionsEl.innerHTML = '<p class="text-red-500">æœªèƒ½ç”Ÿæˆéˆæ„Ÿï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>';
                            rewriteResponseAreaEl.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Error calling Gemini API:', error);
                        rewriteSuggestionsEl.innerHTML = '<p class="text-red-500">ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚</p>';
                        rewriteResponseAreaEl.classList.remove('hidden');
                    } finally {
                        loadingIndicatorEl.classList.add('hidden');
                    }
                };
            } else if (node.type === "end_card") {
                chapterTitleEl.textContent = "åŠ‡çµ‚";
                endCardAreaEl.classList.remove('hidden');
                endCardAreaEl.innerHTML = node.text.replace(/\n/g, '<br>');
                nextButtonEl.classList.add('hidden');
                restartButtonEl.classList.remove('hidden');
            }
            
            gameState.currentNodeId = nodeId;
        }

        function handleChoice(nodeId, choiceIndex) {
            const node = storyData.find(n => n.id === nodeId);
            const choice = node.options[choiceIndex];

            gameState.playerChoices[nodeId] = choice.text;
            if (choice.effect && choice.effect.unlock) {
                gameState.unlocked[choice.effect.unlock] = true;
            }

            if (choice.effect_description) {
                clearContent();
                narrationAreaEl.textContent = `ï¼ˆ${choice.effect_description}ï¼‰`;
                nextButtonEl.classList.remove('hidden');
                nextButtonEl.onclick = () => advanceStory(choice.next);
            } else {
                advanceStory(choice.next);
            }
        }

        function advanceStory(nextNodeId) {
            if (nextNodeId) {
                renderNode(nextNodeId);
            } else {
                console.warn("No next node defined for current state.");
            }
        }

        function restartGame() {
            gameState = {
                currentNodeId: "0_intro",
                unlocked: {},
                playerChoices: {}
            };
            renderNode(gameState.currentNodeId);
        }

        restartButtonEl.onclick = restartGame;

        function initGame() {
            renderNode(gameState.currentNodeId);
        }

        initGame();
    </script>
</body>
</html>
